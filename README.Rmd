---
output: github_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

Rocking R at UMCCR
==================

[![Travis build status](https://travis-ci.org/umccr/rock.svg?branch=umccrise)](https://travis-ci.org/umccr/rock)
[![Coverage status](https://codecov.io/gh/umccr/rock/branch/master/graph/badge.svg)](https://codecov.io/github/umccr/rock?branch=umccrise)

`rock` is an R package that (hopefully) helps with the day to day bioinformatics
life at UMCCR (UniMelb Centre for Cancer Research).

You can do the following:

* Create circos plots using structural variant calls from
  [Manta](https://github.com/Illumina/manta),
  and copy number variant calls from
  [CNVkit](https://github.com/etal/cnvkit),
  [FACETS](https://github.com/mskcc/facets),
  [TitanCNA](https://github.com/gavinha/TitanCNA) or
  [PURPLE](https://github.com/hartwigmedical/hmftools/tree/master/purity-ploidy-estimator).
  The OmicCircos R package is used. You can also use the Perl circos tool for
  Manta with CNVkit.

* Create CNV profiles in horizontal facets for multiple samples or callers (piano plots).
  Can also zoom into specific chromosomes, and include an ideogram when specifying
  a single chromosome.
* Generate bedgraph files for viewing the copy number segments 
  in [IGV](http://software.broadinstitute.org/software/igv/) as a bar plot.
* Generate IGV files for viewing SNP values in IGV as a scatter plot.



## Contents

## Installation

You can install the development version of `rock` from [GitHub](https://github.com/umccr/rock) with:

```r
# install.packages("devtools") # if not pre-installed
devtools::install_github("umccr/rock") # master version
devtools::install_github("umccr/rock@v1.2.3") # release v1.2.3
devtools::install_github("umccr/rock@abcd") # commit abcd
devtools::install_github("umccr/rock", ref = "umccrise") # umccrise branch
```

There is no CRAN or conda version (yet).

Then just load with:

```{r message=FALSE}
require(rock, lib.loc = "~/rock/umccrise")
```


## Circos Plots

### Perl Circos

* We can generate circos plots using the original 
  [circos](http://circos.ca/) software package, written in Perl.
  **Note**: `circos` needs to be installed in your `PATH`.

* Start by preparing the Manta and CNV calls. The required input files
  will be written to `outdir`:

```{r perlcircos-prep}
manta <- system.file("extdata", "HCC2218_manta.vcf", package = "pebbles")
cnv <- system.file("extdata", "HCC2218_cnvkit-call.cns", package = "pebbles")
outdir <- "man/figures/perl_circos"
circos_prep(outdir = outdir, manta = manta, cnv = cnv)
```

* Then execute the following `circos` command either on the command line, or via
  the `plot_circos2` function:

```bash
circos -nosvg -conf <outdir>/circos_simple.conf -outputdir <outdir> -outputfile foo_circos_cnvkit_manta.png
```

```{r perlcircos-plot}
plot_circos2(outdir = outdir, name = "foo")
```

* Result:

```{r perlcircos-include}
knitr::include_graphics("man/figures/perl_circos/foo_circos_cnvkit_manta.png")
```

### OmicCircos

* We can generate circos plots using the functionality available in the
  [OmicCircos](https://bioconductor.org/packages/release/bioc/html/OmicCircos.html)
  Bioconductor R package.

* Start by preparing the SV and CNV calls.

```{r omiccircos-prep, message=FALSE}
manta <- system.file("extdata", "HCC2218_manta.vcf", package = "pebbles")
cnvkit <- system.file("extdata", "HCC2218_cnvkit-call.cns", package = "pebbles")
facets <- system.file("extdata", "HCC2218_facets_cncf.tsv", package = "pebbles")
titan <- system.file("extdata", "HCC2218_titan.segs.tsv", package = "pebbles")
purple <- system.file("extdata", "HCC2218_purple.cnv.tsv", package = "pebbles")
truth <- system.file("extdata", "HCC2218_truthset_cnv_bcbio.tsv", package = "pebbles")

sv_manta <- prep_manta_vcf(manta)
cn_facets <- prep_facets_seg(facets)
cn_cnvkit <- prep_cnvkit_seg(cnvkit)
cn_purple <- prep_purple_seg(purple)
cn_truth <- prep_truth_seg(truth)
cn_titan <- prep_titan_seg(titan) # titan needs -1 for this case
cn_titan$cnv$tot_cn <- cn_titan$cnv$tot_cn - 1
```

* Now we can generate a circos plot with Manta links and FACETS/CNVkit/TitanCNA/PURPLE segments
  (note that the `Warning` message below is due to a hack used in the OmicCircos
  code, where a matrix with numbers and characters is coerced to numeric.
  Just don't worry about it..):

* For the internal lines:
    - The _inter_chromosomal links take the chromosome colour of mate1 of each breakend pair.
    - The _intra_chromosomal lines are coloured according to the variant type:
        - Deletions: Red
        - Duplications: Green
        - Insertions: Purple
        - Inversions: Orange


#### Manta with CNVkit

```{r circos-plot-manta-cnvkit, fig.width=8, fig.height=8}
plot_circos(sv = sv_manta, cnv = cn_cnvkit)
```

#### Manta with PURPLE

```{r circos-plot-manta-purple, fig.width=8, fig.height=8}
plot_circos(sv = sv_manta, cnv = cn_purple)
```

## View CNV segments in IGV

```{r prep-cnv2igv, eval=FALSE}
cn_fname <- system.file("extdata", "HCC2218_purple.cnv.tsv", package = "pebbles")
cnv <- read_cnv(cn_fname)
cnv2igv(cnv, out_file = "~/Desktop/tmp/cnv_segs4igv.bedgraph", track_name = "cnv_segs2")
```

```{r cnv2igv}
knitr::include_graphics("man/figures/README-cnv2igv_output.png")
```

## View BED values in IGV

```{r prep-bedval2igv, eval=FALSE}
bed <- system.file("extdata", "HCC2218_baf.tsv", package = "pebbles")
bedval2igv(bed, out_file = "~/Desktop/tmp/baf1.igv", track_name = "baf", col = "purple")
```

```{r bedval2igv}
# example for COLO829 whole-genome BAFs
knitr::include_graphics("man/figures/README-bedval2igv_output.png")
```
